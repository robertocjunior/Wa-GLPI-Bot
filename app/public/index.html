<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configuração GLPI</title>
    <link rel="stylesheet" href="style.css">nk
</head>
<body>
    <div class="container">
        <a href="/logout" class="logout">Sair</a>
        <h1>Configuração do Sistema</h1>

        <div class="nav-tabs">
            <div class="nav-tab active" data-tab="api-config">Configuração da API</div>
            <div class="nav-tab" data-tab="password-config">Alterar Senha</div>
        </div>

        <!-- Tab 1: Configuração da API -->
        <div id="api-config" class="tab-content active">
            <div id="glpiAlert" class="status error">
                ⚠️ A configuração do GLPI não está completa. O bot não funcionará até que todos os campos sejam preenchidos.
            </div>

            <h2>Configurações do GLPI</h2>
            <div class="form-group">
                <label for="glpiUrl">URL do GLPI:</label>
                <input type="text" id="glpiUrl" placeholder="Ex: http://glpi/apirest.php">
            </div>

            <div class="form-group">
                <label for="appToken">App Token:</label>
                <input type="text" id="appToken" placeholder="Token da aplicação">
            </div>

            <div class="form-group">
                <label for="userToken">User Token:</label>
                <input type="text" id="userToken" placeholder="Token do usuário">
            </div>

            <button id="saveApiBtn">Salvar Configurações da API</button>
            <div id="apiStatus" class="status"></div>
        </div>

        <!-- Tab 2: Alterar Senha -->
        <div id="password-config" class="tab-content">
            <h2>Alterar Credenciais de Acesso</h2>
            <div class="form-group">
                <label for="adminUsername">Usuário:</label>
                <input type="text" id="adminUsername" placeholder="Nome de usuário" readonly>
            </div>

            <div class="form-group">
                <label for="newPassword">Nova Senha:</label>
                <input type="password" id="newPassword" placeholder="Digite a nova senha">
                <div class="password-note">Mínimo de 8 caracteres</div>
            </div>

            <div class="form-group">
                <label for="confirmPassword">Confirmar Nova Senha:</label>
                <input type="password" id="confirmPassword" placeholder="Digite novamente a nova senha">
            </div>

            <div class="form-group">
                <label for="currentPassword">Senha Atual:</label>
                <input type="password" id="currentPassword" placeholder="Sua senha atual">
            </div>

            <button id="savePasswordBtn">Alterar Senha</button>
            <div id="passwordStatus" class="status"></div>
        </div>
    </div>

    <script>
        // Tab navigation
        document.querySelectorAll('.nav-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                // Remove active class from all tabs and contents
                document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                
                // Add active class to clicked tab and corresponding content
                tab.classList.add('active');
                const tabId = tab.getAttribute('data-tab');
                document.getElementById(tabId).classList.add('active');
            });
        });

        // Carrega a configuração atual
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                const response = await fetch('/config');
                const data = await response.json();

                if (data.glpi) {
                    document.getElementById('glpiUrl').value = data.glpi.url || '';
                    document.getElementById('appToken').value = data.glpi.appToken || '';
                    document.getElementById('userToken').value = data.glpi.userToken || '';
                }
                document.getElementById('adminUsername').value = data.auth.username || '';
                
                if (!data.glpi || !data.glpi.url) {
                    document.getElementById('glpiAlert').style.display = 'block';
                }
            } catch (error) {
                console.error('Erro ao carregar configuração:', error);
                showStatus('Erro ao carregar configuração', 'error', 'apiStatus');
            }
        });

        // Função para mostrar mensagens de status
        function showStatus(message, type, elementId) {
            const statusDiv = document.getElementById(elementId);
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
            statusDiv.style.display = 'block';

            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 5000);
        }

        // Salva a configuração da API
        document.getElementById('saveApiBtn').addEventListener('click', async () => {
            const glpiUrl = document.getElementById('glpiUrl').value;
            const appToken = document.getElementById('appToken').value;
            const userToken = document.getElementById('userToken').value;

            // Validação básica
            if (!glpiUrl || !appToken || !userToken) {
                return showStatus('Todos os campos são obrigatórios', 'error', 'apiStatus');
            }

            try {
                const response = await fetch('/config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        glpiUrl,
                        appToken,
                        userToken
                    })
                });

                const result = await response.json();

                if (result.success) {
                    showStatus('Configuração da API salva com sucesso!', 'success', 'apiStatus');
                    if (result.glpiConfigured) {
                        document.getElementById('glpiAlert').style.display = 'none';
                    }
                } else {
                    showStatus(result.message || 'Erro ao salvar configuração', 'error', 'apiStatus');
                }
            } catch (error) {
                console.error('Erro:', error);
                showStatus('Erro ao conectar com o servidor', 'error', 'apiStatus');
            }
        });

        // Altera a senha
        document.getElementById('savePasswordBtn').addEventListener('click', async () => {
            const username = document.getElementById('adminUsername').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const currentPassword = document.getElementById('currentPassword').value;

            // Validações
            if (!currentPassword) {
                return showStatus('A senha atual é obrigatória', 'error', 'passwordStatus');
            }
            
            if (newPassword && newPassword.length < 8) {
                return showStatus('A nova senha deve ter pelo menos 8 caracteres', 'error', 'passwordStatus');
            }
            
            if (newPassword !== confirmPassword) {
                return showStatus('As senhas não coincidem', 'error', 'passwordStatus');
            }

            try {
                const response = await fetch('/config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        adminUsername: username,
                        adminPassword: newPassword,
                        currentPassword
                    })
                });

                const result = await response.json();

                if (result.success) {
                    showStatus('Senha alterada com sucesso!', 'success', 'passwordStatus');
                    // Limpa os campos de senha
                    document.getElementById('newPassword').value = '';
                    document.getElementById('confirmPassword').value = '';
                    document.getElementById('currentPassword').value = '';
                } else {
                    showStatus(result.error || 'Erro ao alterar senha', 'error', 'passwordStatus');
                }
            } catch (error) {
                console.error('Erro:', error);
                showStatus('Erro ao conectar com o servidor', 'error', 'passwordStatus');
            }
        });
    </script>
</body>
</html>